<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Snake Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
        #container { position: relative; width: 100vw; height: 100vh; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; color: white; font-family: sans-serif; font-size: 20px; text-shadow: 2px 2px 2px #000; }
        #startBtn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; padding: 15px 30px; font-size: 24px; background: #0f0; border: none; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">Score: <span id="score">0</span></div>
        <button id="startBtn" onclick="startCamera()">点击开始游戏</button>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

<script type="module">
import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

let handLandmarker = undefined;
let lastVideoTime = -1;
const video = document.getElementById("webcam");
const canvas = document.getElementById("output_canvas");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");
const btn = document.getElementById("startBtn");

let snake = [];
let food = {x: 0, y: 0};
let score = 0;
let w, h;

// 初始化 AI 模型
async function createHandLandmarker() {
  const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
      delegate: "GPU"
    },
    runningMode: "VIDEO",
    numHands: 1
  });
  btn.innerText = "点击开始 (模型已加载)";
}
createHandLandmarker();

// 开启摄像头
window.startCamera = async function() {
    if (!handLandmarker) { alert("模型还在加载中，请稍等..."); return; }
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "user", width: 1280, height: 720 } 
        });
        video.srcObject = stream;
        video.addEventListener("loadeddata", predictWebcam);
        btn.style.display = "none";
        resetGame();
    } catch(err) {
        alert("无法打开摄像头: " + err);
    }
}

function resetGame() {
    w = canvas.width = video.videoWidth;
    h = canvas.height = video.videoHeight;
    snake = [];
    score = 0;
    spawnFood();
}

function spawnFood() {
    food.x = Math.random() * (w - 100) + 50;
    food.y = Math.random() * (h - 100) + 50;
}

async function predictWebcam() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    w = canvas.width; h = canvas.height;
    
    let startTimeMs = performance.now();
    if (lastVideoTime !== video.currentTime) {
        lastVideoTime = video.currentTime;
        const results = handLandmarker.detectForVideo(video, startTimeMs);

        ctx.clearRect(0, 0, w, h);

        if (results.landmarks && results.landmarks.length > 0) {
            const lm = results.landmarks[0][8]; // 食指
            const cx = lm.x * w;
            const cy = lm.y * h;

            // 蛇逻辑
            snake.push({x: cx, y: cy});
            
            // 吃食物
            const dist = Math.hypot(food.x - cx, food.y - cy);
            if (dist < 40) {
                score++;
                scoreEl.innerText = score;
                spawnFood();
            } else {
                if (snake.length > 20 + score * 5) snake.shift();
            }

            // 绘制
            drawSnake();
            drawFood();
        }
    }
    window.requestAnimationFrame(predictWebcam);
}

function drawSnake() {
    ctx.fillStyle = "#00ff00";
    snake.forEach((p, i) => {
        ctx.beginPath();
        let r = 10 + i/2;
        ctx.arc(p.x, p.y, r > 30 ? 30 : r, 0, 2 * Math.PI);
        ctx.fill();
    });
}

function drawFood() {
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(food.x, food.y, 20, 0, 2 * Math.PI);
    ctx.fill();
}
</script>
</body>
</html>